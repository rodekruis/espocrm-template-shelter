{
    "beforeSaveCustomScript": "// Calculate HH members\nif (calculateMembers) {\n    $memberCount = 0;\n    $numberOfMales = 0;\n    $numberOfFemales = 0;\n    $numberOfChildren = 0;\n    $numberOfPregnant = 0;\n    $i = 0;\n    $today = datetime\\now();\n    while ($i < array\\length(cPersonAffectedIds)) {\n        $PAID = array\\at(cPersonAffectedIds, $i);\n        $PAGender = record\\attribute(\"CPersonAffected\", $PAID, \"gender\");\n        $PAPregnant = record\\attribute(\"CPersonAffected\", $PAID, \"isThisMemberAPregnantWoman\");\n        $PABirthday = record\\attribute(\"CPersonAffected\", $PAID, \"dateofbirth\");\n        $age = datetime\\diff($today, $PABirthday, 'years');\n        if ($PAGender == \"male\") {\n            $numberOfMales = $numberOfMales + 1; \n        } else if ($PAGender == \"female\") {\n            $numberOfFemales = $numberOfFemales + 1;    \n        };\n        if ($age < 18) {\n            $numberOfChildren = $numberOfChildren + 1;\n        };\n        if ($PAPregnant == true) {\n            $numberOfPregnant = $numberOfPregnant + 1;\n        };\n        $memberCount = $memberCount + 1;\n        $i = $i + 1;\n    };\n    memberCount = $memberCount;\n    calculatedMale = $numberOfMales;\n    calculatedFemale = $numberOfFemales;\n    calculatedChildren = $numberOfChildren;\n    calculatedPregnant = $numberOfPregnant;\n};\n\n// Fix logic related to HHH\nif (cHeadOfHouseHoldId != null) {\n    // if HHH not among HH members, add them\n    if (!array\\includes(cPersonAffectedIds, cHeadOfHouseHoldId)) {\n        cPersonAffectedIds = array\\push(cPersonAffectedIds, cHeadOfHouseHoldId);\n    }\n} else {\n    // if no HHH specified, set as oldest of HH members\n    $oldestPersonAffectedId = record\\findRelatedOne('CHousehold', id, 'cPersonAffected', 'age', 'desc', 'cHouseholdId=', id);\n    if ($oldestPersonAffectedId) {\n        cHeadOfHouseHoldId = $oldestPersonAffectedId;\n    };\n};\n\n// Assign HH name\nif (cHeadOfHouseHoldId != null) {\n    name = string\\concatenate(\"Household \", record\\attribute('CPersonAffected', cHeadOfHouseHoldId, 'lastName'));\n} else {\n    name = internalID;\n}"
}